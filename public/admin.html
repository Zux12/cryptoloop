<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Admin Panel | CryptoLoop</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <meta name="color-scheme" content="dark">
  <style>
    .badge{@apply inline-flex items-center gap-1 rounded-full px-2 py-0.5 text-xs font-semibold}
    .badge-green{ @apply bg-emerald-900/40 text-emerald-300 ring-1 ring-emerald-700/40 }
    .badge-red{   @apply bg-red-900/40 text-red-300 ring-1 ring-red-700/40 }
    .badge-yellow{@apply bg-yellow-900/40 text-yellow-300 ring-1 ring-yellow-700/40 }
    .badge-blue{  @apply bg-blue-900/40 text-blue-300 ring-1 ring-blue-700/40 }
    .card{ @apply bg-gray-900/60 border border-gray-800 rounded-xl shadow-lg }
    .tbl{  @apply min-w-full text-sm bg-gray-900/50 }
    .th{   @apply p-2 border border-gray-800 bg-gray-800/80 text-left font-semibold sticky top-0 z-10 }
    .td{   @apply p-2 border border-gray-800 align-top }
    .row{  @apply border-b border-gray-800 hover:bg-gray-800/40 transition-colors }
    .skeleton{ @apply animate-pulse bg-gray-800/80 rounded }
    .btn{ @apply inline-flex items-center justify-center gap-2 rounded-lg px-3 py-2 font-semibold transition-colors }
    .btn-ghost{ @apply hover:bg-gray-800/60 border border-gray-800 }
    .btn-primary{ @apply bg-emerald-600 hover:bg-emerald-500 text-white }
    .btn-danger{ @apply bg-red-600 hover:bg-red-500 text-white }
    .btn-warning{ @apply bg-yellow-600 hover:bg-yellow-500 text-white }
    .btn-info{ @apply bg-blue-600 hover:bg-blue-500 text-white }
    .input{ @apply w-full rounded-lg border border-gray-800 bg-gray-900/70 px-3 py-2 outline-none focus:ring-2 focus:ring-emerald-600 }
    .toolbar{ @apply flex flex-wrap items-center gap-2 }
    .table-wrap{ @apply overflow-auto max-w-full }
  </style>
</head>
<body class="bg-gray-950 text-gray-100 min-h-screen font-sans selection:bg-emerald-700 selection:text-white">

  <!-- Sticky Top Bar -->
  <header class="sticky top-0 z-40 border-b border-gray-800 bg-gray-950/80 backdrop-blur">
    <div class="mx-auto max-w-7xl px-4 py-3 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <img src="images/logo.png" alt="CryptoLoop Logo" class="h-9 w-auto rounded" />
        <div>
          <h1 class="text-xl md:text-2xl font-bold tracking-tight">CryptoLoop Admin</h1>
          <p class="text-xs text-gray-400">Manage users, approvals & portfolio snapshots</p>
        </div>
      </div>
      <div class="flex items-center gap-2">
        <label class="text-sm flex items-center gap-2">
          <input id="autoRefreshToggle" type="checkbox" class="h-4 w-4 rounded border-gray-700 bg-gray-900" />
          Auto-refresh (30s)
        </label>
        <button id="refreshAllBtn" class="btn btn-ghost">üîÑ Refresh all</button>
        <button onclick="logout()" class="btn btn-danger">üîê Logout</button>
      </div>
    </div>
  </header>

  <!-- Toast / Status -->
  <div id="toast" class="fixed left-1/2 -translate-x-1/2 top-4 z-50 hidden">
    <div id="toastInner" class="rounded-lg border border-gray-800 bg-gray-900/90 px-4 py-2 text-sm shadow-xl"></div>
  </div>

  <main class="mx-auto max-w-7xl px-4 py-6 space-y-10">

    <!-- USERS (Admin Approval) -->
    <section class="card p-4">
      <div class="flex flex-wrap items-center justify-between gap-3 mb-3">
        <div>
          <h2 class="text-lg md:text-xl font-bold">üë• Users (Approval)</h2>
          <p class="text-xs text-gray-400">Review new signups and toggle access</p>
        </div>
        <div class="toolbar">
          <input id="userSearch" class="input" placeholder="Search users by email/name/agent‚Ä¶" />
          <select id="userFilter" class="input max-w-[180px]">
            <option value="all">All</option>
            <option value="approved">Approved</option>
            <option value="pending">Pending</option>
          </select>
          <button id="refreshUsersBtn" class="btn btn-ghost">üîÑ Refresh</button>
        </div>
      </div>

      <div class="table-wrap rounded-lg">
        <table class="tbl">
          <thead class="bg-gray-800">
            <tr>
              <th class="th">Email</th>
              <th class="th">Name</th>
              <th class="th">Agent</th>
              <th class="th">Status</th>
              <th class="th">Created</th>
              <th class="th text-center">Actions</th>
            </tr>
          </thead>
          <tbody id="admin-users-body"></tbody>
        </table>
      </div>
    </section>

    <!-- BUY REQUESTS -->
    <section class="card p-4">
      <div class="flex flex-wrap items-center justify-between gap-3 mb-3">
        <div>
          <h2 class="text-lg md:text-xl font-bold">üü¢ Pending Buy Requests</h2>
          <p class="text-xs text-gray-400">Approve or reject incoming buy orders</p>
        </div>
        <div class="toolbar">
          <button id="refreshBuyBtn" class="btn btn-ghost">üîÑ Refresh</button>
        </div>
      </div>
      <div class="table-wrap rounded-lg">
        <table class="tbl">
          <thead class="bg-gray-800">
            <tr>
              <th class="th">User</th>
              <th class="th">Symbol</th>
              <th class="th">USD</th>
              <th class="th">Amount</th>
              <th class="th">Timestamp</th>
              <th class="th text-center">Actions</th>
            </tr>
          </thead>
          <tbody id="admin-buy-request-body"></tbody>
        </table>
      </div>
    </section>

    <!-- SELL REQUESTS -->
    <section class="card p-4">
      <div class="flex flex-wrap items-center justify-between gap-3 mb-3">
        <div>
          <h2 class="text-lg md:text-xl font-bold">üõí Pending Sell Requests</h2>
          <p class="text-xs text-gray-400">Handle approval, freeze, transfer, or rejection</p>
        </div>
        <div class="toolbar">
          <button id="refreshSellBtn" class="btn btn-ghost">üîÑ Refresh</button>
        </div>
      </div>
      <div class="table-wrap rounded-lg">
        <table class="tbl">
          <thead class="bg-gray-800">
            <tr>
              <th class="th">User</th>
              <th class="th">Symbol</th>
              <th class="th">Amount</th>
              <th class="th">Timestamp</th>
              <th class="th">Status</th>
              <th class="th">Status Timestamp</th>
              <th class="th text-center">Actions</th>
            </tr>
          </thead>
          <tbody id="admin-sell-body"></tbody>
        </table>
      </div>
    </section>

    <!-- ACCOUNTS OVERVIEW -->
    <section class="card p-4">
      <div class="flex flex-wrap items-center justify-between gap-3 mb-3">
        <div>
          <h2 class="text-lg md:text-xl font-bold">üìí Accounts Overview</h2>
          <p class="text-xs text-gray-400">User wallet snapshots, TPV and AI values</p>
        </div>
        <div class="toolbar">
          <button id="exportCsvBtn" class="btn btn-info">‚¨áÔ∏è Export CSV</button>
          <button id="refreshOverviewBtn" class="btn btn-ghost">üîÑ Refresh</button>
        </div>
      </div>
      <div class="table-wrap rounded-lg">
        <table class="tbl">
          <thead class="bg-gray-800">
            <tr>
              <th class="th">Name</th>
              <th class="th">Email</th>
              <th class="th">Agent</th>
              <th class="th">Approved</th>
              <th class="th">Last Login</th>
              <th class="th">Location</th>
              <th class="th">Wallet</th>
              <th class="th">TPV (USD)</th>
              <th class="th">AI Value</th>
              <th class="th">AI Updated</th>
            </tr>
          </thead>
          <tbody id="admin-accounts-body"></tbody>
        </table>
      </div>
    </section>
  </main>

<script>
/* ======================
   Small utils
====================== */
const $ = (sel, root=document) => root.querySelector(sel);
const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));
const fmtMoney = (n) => {
  const v = Number(n || 0);
  return isFinite(v) ? v.toLocaleString(undefined, { style: 'currency', currency: 'USD', maximumFractionDigits: 2 }) : '-';
};
const fmtDate = (d) => d ? new Date(d).toLocaleString() : '‚Äî';

function showToast(msg, type='neutral'){
  const wrap = $('#toast'), inner = $('#toastInner');
  inner.textContent = msg;
  inner.className = 'rounded-lg border px-4 py-2 text-sm shadow-xl ' + (
    type === 'ok' ? 'border-emerald-800 bg-emerald-900/90 text-emerald-100' :
    type === 'err'? 'border-red-800 bg-red-900/90 text-red-100' :
                    'border-gray-800 bg-gray-900/90 text-gray-100'
  );
  wrap.classList.remove('hidden');
  clearTimeout(showToast._t);
  showToast._t = setTimeout(()=>wrap.classList.add('hidden'), 2600);
}

/* ======================
   Auth Gate
====================== */
(async function ensureAdmin(){
  const token = localStorage.getItem('token');
  if(!token){ return location.replace('/login.html'); }
  try{
    const r = await fetch('/api/admin/ping', { headers:{ Authorization:'Bearer '+token }});
    if(r.status === 401){ localStorage.removeItem('token'); alert('Session expired. Please log in again.'); return location.replace('/login.html'); }
    if(r.status === 403){ alert('Your account is not an admin.'); return location.replace('/dashboard.html'); }
  }catch(e){ console.error('Admin ping error:', e); }
})();

function logout(){
  localStorage.removeItem('token');
  location.href = '/login.html';
}
window.logout = logout;

/* ======================
   Fetch helper
====================== */
async function fetchJSON(url, opts={}){
  const token = localStorage.getItem('token') || '';
  const headers = {
    'Content-Type':'application/json',
    ...(opts.headers||{}),
    ...(token? { Authorization:'Bearer '+token } : {})
  };
  const res = await fetch(url, { ...opts, headers });
  if(res.status === 401){ localStorage.removeItem('token'); showToast('Session expired','err'); setTimeout(()=>location.replace('/login.html'), 800); }
  if(res.status === 403){ showToast('Admin only area','err'); setTimeout(()=>location.replace('/dashboard.html'), 800); }
  let data=null, raw=null;
  try{ raw = await res.text(); data = raw ? JSON.parse(raw) : null; }catch{ raw = raw || ''; }
  return { ok: res.ok, status: res.status, data, raw };
}

/* =========================
   USERS (Approval)
========================= */
let _usersCache = [];

function renderUsersTable(users){
  const tbody = $('#admin-users-body');
  if(!users.length){
    tbody.innerHTML = `<tr><td class="td text-center text-gray-400" colspan="6">No users found</td></tr>`;
    return;
  }
  tbody.innerHTML = users.map(u => {
    const statusBadge = u.isApproved
      ? `<span class="badge badge-green">‚úÖ Approved</span>`
      : `<span class="badge badge-red">‚ùå Pending</span>`;
    return `
      <tr class="row">
        <td class="td break-all">
          <button class="underline underline-offset-2 text-emerald-300 hover:text-emerald-200" title="Copy email" onclick="navigator.clipboard.writeText('${u.email}'); showToast('Email copied','ok')">${u.email}</button>
        </td>
        <td class="td">${u.name || '-'}</td>
        <td class="td">${u.agent || '-'}</td>
        <td class="td">${statusBadge}</td>
        <td class="td">${fmtDate(u.createdAt)}</td>
        <td class="td text-center">
          ${u.isApproved ? '‚Äî' : `
            <div class="flex items-center justify-center gap-2">
              <button class="btn btn-primary px-2 py-1 text-xs" onclick="approveUser('${u._id}')">Approve</button>
              <button class="btn btn-danger px-2 py-1 text-xs" onclick="rejectUser('${u._id}')">Reject</button>
            </div>
          `}
        </td>
      </tr>
    `;
  }).join('');
}

async function loadUsers(){
  skeletonRows('#admin-users-body', 4, 6);
  const r = await fetchJSON('/api/admin/users');
  if(!r.ok){ return setErrorRow('#admin-users-body', 6, `/api/admin/users ${r.status}`); }
  _usersCache = Array.isArray(r.data) ? r.data : [];
  applyUserFilters();
}

function applyUserFilters(){
  const q = ($('#userSearch')?.value || '').trim().toLowerCase();
  const f = $('#userFilter')?.value || 'all';
  const out = _usersCache.filter(u=>{
    const hits = [u.email, u.name, u.agent].filter(Boolean).join(' ').toLowerCase().includes(q);
    const pass = f==='all' || (f==='approved' && u.isApproved) || (f==='pending' && !u.isApproved);
    return hits && pass;
  });
  renderUsersTable(out);
}

async function approveUser(id){
  const r = await fetch(`/api/admin/approve/${id}`, { method:'PATCH', headers:{ Authorization:'Bearer '+(localStorage.getItem('token')||'') }});
  const j = await r.json().catch(()=>({}));
  if(r.ok){ showToast('User approved','ok'); await loadUsers(); } else { showToast(`Approve failed: ${j.msg || r.status}`,'err'); }
}

async function rejectUser(id){
  if(!confirm('Remove this user?')) return;
  const r = await fetch(`/api/admin/reject/${id}`, { method:'PATCH', headers:{ Authorization:'Bearer '+(localStorage.getItem('token')||'') }});
  const j = await r.json().catch(()=>({}));
  if(r.ok){ showToast('User removed','ok'); await loadUsers(); } else { showToast(`Reject failed: ${j.msg || r.status}`,'err'); }
}

/* =========================
   BUY REQUESTS
========================= */
async function fetchRequests(){
  skeletonRows('#admin-buy-request-body', 4, 6);
  const r = await fetchJSON('/api/admin/buy-requests');
  const body = $('#admin-buy-request-body');
  if(!r.ok){ return setErrorRow('#admin-buy-request-body', 6, `/api/admin/buy-requests ${r.status}`); }
  const rows = Array.isArray(r.data) ? r.data : [];
  if(!rows.length){ body.innerHTML = `<tr><td class="td text-center text-gray-400" colspan="6">No pending buy requests</td></tr>`; return; }

  body.innerHTML = rows.map(req => `
    <tr class="row">
      <td class="td break-all">${req.user}</td>
      <td class="td">${req.symbol}</td>
      <td class="td">${fmtMoney(req.usd)}</td>
      <td class="td">${(+req.amount).toFixed(6)}</td>
      <td class="td">${fmtDate(req.timestamp)}</td>
      <td class="td text-center">
        <div class="flex items-center justify-center gap-2">
          <button onclick="handleBuyAction('${req._id}', 'approve')" class="btn btn-primary px-2 py-1 text-xs">‚úÖ Approve</button>
          <button onclick="handleBuyAction('${req._id}', 'reject')" class="btn btn-danger px-2 py-1 text-xs">‚ùå Reject</button>
        </div>
      </td>
    </tr>
  `).join('');
}

async function handleBuyAction(id, action){
  const endpoint = action === 'approve' ? '/api/admin/approve' : '/api/admin/reject';
  const r = await fetchJSON(endpoint, { method:'POST', body: JSON.stringify({ id }) });
  if(r.ok){ showToast(`Buy ${action}d`,'ok'); fetchRequests(); loadAccountsOverview(); }
  else{ showToast(`Buy ${action} failed: ${r.raw || r.status}`,'err'); }
}

/* =========================
   SELL REQUESTS
========================= */
async function fetchSellRequests(){
  skeletonRows('#admin-sell-body', 4, 7);
  const r = await fetchJSON('/api/admin/sell-requests');
  const body = $('#admin-sell-body');
  if(!r.ok){ return setErrorRow('#admin-sell-body', 7, `/api/admin/sell-requests ${r.status}`); }
  const requests = Array.isArray(r.data) ? r.data : [];
  if(!requests.length){ body.innerHTML = `<tr><td class="td text-center text-gray-400" colspan="7">No pending sell requests</td></tr>`; return; }

  body.innerHTML = requests.map(req => {
    const statusBadge =
      req.status === 'Pending' ? `<span class="badge badge-yellow">Pending</span>` :
      req.status === 'Frozen'  ? `<span class="badge badge-blue">Frozen</span>`   :
      req.status === 'Approved'? `<span class="badge badge-green">Approved</span>`:
                                  `<span class="badge badge-red">Rejected</span>`;
    const canAct = req.status === 'Pending' || req.status === 'Frozen';
    return `
      <tr class="row">
        <td class="td break-all">${req.user}</td>
        <td class="td">${req.symbol}</td>
        <td class="td">${(+req.amount).toFixed(6)}</td>
        <td class="td">${fmtDate(req.timestamp)}</td>
        <td class="td">${statusBadge}</td>
        <td class="td">${fmtDate(req.statusTimestamp)}</td>
        <td class="td text-center">
          ${canAct ? `
            <div class="flex items-center justify-center gap-2">
              <button onclick="updateSellStatus('${req._id}', 'approve')"  class="btn btn-primary px-2 py-1 text-xs">‚úÖ Approve</button>
              <button onclick="updateSellStatus('${req._id}', 'reject')"   class="btn btn-danger px-2 py-1 text-xs">‚ùå Reject</button>
              <button onclick="updateSellStatus('${req._id}', 'frozen')"   class="btn btn-warning px-2 py-1 text-xs">üßä Freeze</button>
              <button onclick="updateSellStatus('${req._id}', 'transfer')" class="btn btn-info px-2 py-1 text-xs">üí∏ Transfer</button>
            </div>` : '‚Äî'}
        </td>
      </tr>
    `;
  }).join('');
}

async function updateSellStatus(id, status){
  const r = await fetchJSON('/api/admin/sell-update', { method:'POST', body: JSON.stringify({ id, status }) });
  if(r.ok){ showToast(`Sell ${status} successful`,'ok'); fetchSellRequests(); loadAccountsOverview(); }
  else{ showToast(`sell-update failed: ${r.raw || r.status}`,'err'); }
}

/* =========================
   ACCOUNTS OVERVIEW (TPV + AI)
========================= */
const ID_MAP = {
  btc:'bitcoin', eth:'ethereum', usdt:'tether', usdc:'usd-coin',
  bnb:'binancecoin', xrp:'ripple', ada:'cardano', sol:'solana',
  doge:'dogecoin', dot:'polkadot', matic:'polygon', shib:'shiba-inu',
  trx:'tron', ltc:'litecoin', avax:'avalanche-2', link:'chainlink',
  uni:'uniswap', atom:'cosmos', xlm:'stellar', bch:'bitcoin-cash',
  icp:'internet-computer', etc:'ethereum-classic', vet:'vechain',
  fil:'filecoin', apt:'aptos', hbar:'hedera-hashgraph', near:'near'
};
let _overviewCache = [];

async function loadAccountsOverview(){
  skeletonRows('#admin-accounts-body', 4, 10);
  const r = await fetchJSON('/api/admin/users/overview');
  const tbody = $('#admin-accounts-body');
  if(!r.ok){ return setErrorRow('#admin-accounts-body', 10, `/api/admin/users/overview ${r.status}`); }

  const rows = Array.isArray(r.data) ? r.data : [];
  _overviewCache = rows;

  if(!rows.length){
    tbody.innerHTML = `<tr><td class="td text-center text-gray-400" colspan="10">No users</td></tr>`;
    return;
  }

  tbody.innerHTML = rows.map(u => {
    const w = u.wallet || {};
    const walletShort = Object.keys(w).length
      ? Object.entries(w).map(([k,v]) => `${k.toUpperCase()}:${(+v).toFixed(6)}`).join(', ')
      : '‚Äî';
    const location = [u.lastLoginCity, u.lastLoginCountry].filter(Boolean).join(', ') || '‚Äî';
    const aiVal = u.aiSim?.simulatedValue != null ? fmtMoney(+u.aiSim.simulatedValue) : '‚Äî';
    return `
      <tr class="row" data-user-id="${u._id}">
        <td class="td">${u.name || '-'}</td>
        <td class="td break-all">${u.email}</td>
        <td class="td">${u.agent || '-'}</td>
        <td class="td">${u.isApproved ? '‚úÖ' : '‚ùå'}</td>
        <td class="td">${fmtDate(u.lastLoginAt)}</td>
        <td class="td">${location}</td>
        <td class="td">${walletShort}</td>
        <td class="td tpv-cell">‚Ä¶</td>
        <td class="td">${aiVal}</td>
        <td class="td">${fmtDate(u.aiSim?.lastUpdated)}</td>
      </tr>
    `;
  }).join('');

  await fillTPV(rows);
}

async function fillTPV(users){
  const symbols = new Set();
  users.forEach(u => Object.keys(u.wallet || {}).forEach(s => symbols.add(s.toLowerCase())));
  if(!symbols.size) return;

  const ids = Array.from(symbols).map(s => ID_MAP[s] || s);
  const uniqueIds = Array.from(new Set(ids)).filter(Boolean);
  if(!uniqueIds.length) return;

  let prices = {};
  try{
    const url = `https://api.coingecko.com/api/v3/simple/price?ids=${encodeURIComponent(uniqueIds.join(','))}&vs_currencies=usd`;
    const res = await fetch(url);
    prices = await res.json();
  }catch(e){
    console.warn('TPV price fetch failed', e);
    return;
  }

  users.forEach(u => {
    const w = u.wallet || {};
    let tpv = 0;
    for(const [sym, amt] of Object.entries(w)){
      const id = ID_MAP[sym.toLowerCase()] || sym.toLowerCase();
      const p = prices[id]?.usd || 0;
      tpv += (+amt) * (+p);
    }
    const cell = document.querySelector(`tr[data-user-id="${u._id}"] .tpv-cell`);
    if(cell) cell.textContent = fmtMoney(tpv);
  });
}

/* ======================
   Skeletons & Errors
====================== */
function skeletonRows(tbodySel, rows=3, cols=6){
  const tb = $(tbodySel);
  tb.innerHTML = Array.from({length:rows}).map(()=>`
    <tr class="row">
      ${Array.from({length:cols}).map(()=>`<td class="td"><div class="skeleton h-5 w-full"></div></td>`).join('')}
    </tr>
  `).join('');
}
function setErrorRow(tbodySel, cols, msg){
  $(tbodySel).innerHTML = `<tr><td class="td text-center text-red-400" colspan="${cols}">‚ùå ${msg}</td></tr>`;
}

/* ======================
   CSV Export (Overview)
====================== */
function exportOverviewCSV(){
  if(!_overviewCache.length){ showToast('Nothing to export','err'); return; }
  const header = ['Name','Email','Agent','Approved','Last Login','City','Country','Wallet','TPV(USD)','AI Value','AI Updated'];
  const lines = [_overviewCache.map(u => {
    const w = u.wallet || {};
    const walletShort = Object.keys(w).length
      ? Object.entries(w).map(([k,v]) => `${k.toUpperCase()}:${(+v).toFixed(6)}`).join(' | ')
      : '';
    const aiVal = u.aiSim?.simulatedValue != null ? (+u.aiSim.simulatedValue).toFixed(2) : '';
    return [
      u.name || '',
      u.email || '',
      u.agent || '',
      u.isApproved ? 'Yes' : 'No',
      u.lastLoginAt ? new Date(u.lastLoginAt).toISOString() : '',
      u.lastLoginCity || '',
      u.lastLoginCountry || '',
      walletShort,
      '', // TPV calculated client-side (we won‚Äôt recompute here)
      aiVal,
      u.aiSim?.lastUpdated ? new Date(u.aiSim.lastUpdated).toISOString() : ''
    ];
  })];
  // Build CSV
  const rows = [header].concat(lines[0]);
  const csv = rows.map(r => r.map(x => `"${String(x).replace(/"/g,'""')}"`).join(',')).join('\n');
  const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = 'accounts_overview.csv';
  document.body.appendChild(a); a.click(); a.remove();
  URL.revokeObjectURL(url);
  showToast('CSV exported','ok');
}

/* ======================
   Auto Refresh
====================== */
let _poll = null;
function startAutoRefresh(){
  clearInterval(_poll);
  _poll = setInterval(()=>{ refreshAll(); }, 30000);
}
function stopAutoRefresh(){ clearInterval(_poll); _poll = null; }
function refreshAll(){ loadUsers(); fetchRequests(); fetchSellRequests(); loadAccountsOverview(); }

/* ======================
   Wire up UI
====================== */
document.addEventListener('DOMContentLoaded', () => {
  // Initial loads
  refreshAll();

  // Controls
  $('#refreshAllBtn')?.addEventListener('click', refreshAll);
  $('#refreshUsersBtn')?.addEventListener('click', loadUsers);
  $('#refreshBuyBtn')?.addEventListener('click', fetchRequests);
  $('#refreshSellBtn')?.addEventListener('click', fetchSellRequests);
  $('#refreshOverviewBtn')?.addEventListener('click', loadAccountsOverview);
  $('#exportCsvBtn')?.addEventListener('click', exportOverviewCSV);

  // Filters
  $('#userSearch')?.addEventListener('input', debounce(applyUserFilters, 150));
  $('#userFilter')?.addEventListener('change', applyUserFilters);

  // Auto-refresh
  const tgl = $('#autoRefreshToggle');
  const saved = localStorage.getItem('admin_auto_refresh') === '1';
  tgl.checked = saved;
  if(saved) startAutoRefresh();
  tgl.addEventListener('change', (e)=>{
    if(e.target.checked){ localStorage.setItem('admin_auto_refresh','1'); startAutoRefresh(); }
    else{ localStorage.removeItem('admin_auto_refresh'); stopAutoRefresh(); }
  });
});

// simple debounce
function debounce(fn, ms=200){
  let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), ms); };
}
</script>

</body>
</html>
